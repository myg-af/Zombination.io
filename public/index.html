<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Zombination.io</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #222; color: white; font-family: Arial, sans-serif; }
    #gameCanvas { display: block; background: #222; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
    #hudStats { position: fixed; left: 10px; bottom: 10px; background: rgba(0,0,0,0.7); border-radius: 7px; padding: 10px 20px 10px 15px; font-size: 18px; user-select: none; min-width: 210px; }
    #hudAlive { font-weight: bold; color: #fd7; }
    #deathScreen { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(30,0,0,0.8); z-index: 3; justify-content: center; align-items: center; flex-direction: column; }
    #deathScreenInner { background: #181818; border-radius: 20px; padding: 35px 45px; color: #fff; box-shadow: 0 6px 30px #000c; text-align: center; min-width: 320px; }
    #deathScreen h2 { margin: 0 0 15px 0; color: #fc2c3c; }
    #deathStats { margin-bottom: 15px; font-size: 20px; }
    #btnReplay { background: #222; color: #fff; padding: 10px 32px; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; transition: background 0.16s; }
    #btnReplay:hover { background: #393; color: #fff; }
    /* --- LOBBY --- */
    #lobbyScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; left:0;top:0;width:100vw;height:100vh;z-index:10; background: #181c; }
    #lobbyBox { background: #19191e; border-radius: 20px; padding: 36px 42px; box-shadow: 0 6px 30px #000c; min-width: 350px; min-height: 190px; text-align: center; position: relative; }
    #lobbyBox:after {
      content: "Version 1.0.0 par Myg";
      position: absolute;
      bottom: 12px;
      right: 18px;
      font-size: 12px;
      color: #999;
      user-select: none;
    }
    #lobbyBox input[type=text] { font-size: 20px; padding: 7px 12px; border-radius: 7px; border: 1px solid #444; outline: none; margin-bottom: 10px; width: 175px; }
    #lobbyJoin { padding: 7px 32px; border-radius: 8px; border:none; font-size: 20px; background:#49c749; color: #fff; cursor: pointer; margin-top: 7px; }
    #lobbyJoin[disabled] { opacity: 0.6; cursor: not-allowed; }
    #lobbyPlayers { margin: 18px 0 12px 0; color: #9fd; }
    #lobbyTimer { font-size: 17px; margin-bottom: 9px; }
    #lobbyStatus { margin: 4px 0 0 0; color: #ccc; font-size: 14px; }

    /* --- LANG SELECT --- */
    #langSelectRow {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      gap: 13px;
      user-select: none;
    }
    .langFlag {
      width: 38px;
      height: 26px;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border 0.14s, transform 0.12s;
      background: #fff2;
      object-fit: cover;
      box-shadow: 0 2px 10px #0003;
    }
    .langFlag.selected {
      border: 2.5px solid #33fc69;
      transform: scale(1.07);
      box-shadow: 0 2px 16px #33fc6930;
    }

    /* --- WAVE MESSAGE --- */
    #waveMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #f2f263;
      font-size: 48px;
      font-weight: bold;
      text-shadow: 2px 2px 6px #000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
      z-index: 20;
      user-select: none;
    }

    /* --- JOYSTICKS MOBILE --- */
    #joystickMove, #joystickAim {
      position: fixed;
      width: 140px;
      height: 140px;
      background: rgba(255, 255, 255, 0.14);
      border-radius: 50%;
      user-select: none;
      touch-action: none;
      z-index: 30;
      opacity: 0.4;
      transition: opacity 0.2s;
    }
    #joystickMove {
      bottom: 70px;
      left: 40px;
    }
    #joystickAim {
      bottom: 70px;
      right: 40px;
    }
    #joystickMove.active, #joystickAim.active {
      opacity: 0.8;
    }
    #stickMove, #stickAim {
      position: absolute;
      width: 70px;
      height: 70px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      top: 35px;
      left: 35px;
      touch-action: none;
      transition: background 0.3s;
    }
    #stickMove:active, #stickAim:active {
      background: rgba(255, 255, 255, 1);
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hudStats">
    <div id="hudAlive"></div>
    <div id="hudZombies"></div>
    <div id="hudKills"></div>
    <div id="hudRound"></div>
    <div id="hudHP"></div>
  </div>
  <div id="deathScreen">
    <div id="deathScreenInner">
      <h2 id="deathTitle"></h2>
      <div id="deathStats"></div>
      <button id="btnReplay"></button>
    </div>
  </div>
  <div id="lobbyScreen">
    <div id="lobbyBox">
      <div id="lobbyTitle" style="font-size: 28px; margin-bottom: 18px;"><b>Zombination.io</b></div>
      <div id="lobbyPlayers"></div>
      <div id="lobbyTimer"></div>
      <div id="lobbyStatus"></div>
      <input type="text" id="pseudoInput" maxlength="15" placeholder="" />
      <br>
      <button id="lobbyJoin"></button>
      <div id="langSelectRow"></div>
    </div>
  </div>

  <div id="waveMessage"></div>

  <div id="joystickMove" style="display:none;">
    <div id="stickMove"></div>
  </div>
  <div id="joystickAim" style="display:none;">
    <div id="stickAim"></div>
  </div>
  <script src="/translations.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const LANGS = [
      { code: 'en', flag: 'gb.png', label: 'English' },
      { code: 'cn', flag: 'cn.png', label: '中文' },
      { code: 'ru', flag: 'ru.png', label: 'Русский' },
      { code: 'es', flag: 'es.png', label: 'Español' },
      { code: 'pt', flag: 'pt.png', label: 'Português' },
      { code: 'de', flag: 'de.png', label: 'Deutsch' },
      { code: 'jp', flag: 'jp.png', label: '日本語' },
      { code: 'fr', flag: 'fr.png', label: 'Français' },
      { code: 'pl', flag: 'pl.png', label: 'Polski' },
      { code: 'kr', flag: 'kr.png', label: '한국어' }
    ];

    let currentLang = "en";
    let lobbyData = {};
    let lobbyJoined = false;
    let lobbyStarted = false;

    const pseudoInput = document.getElementById('pseudoInput');
    const lobbyJoin = document.getElementById('lobbyJoin');
    const lobbyPlayers = document.getElementById('lobbyPlayers');
    const lobbyTimer = document.getElementById('lobbyTimer');
    const lobbyStatus = document.getElementById('lobbyStatus');
    const deathTitle = document.getElementById('deathTitle');
    const deathStats = document.getElementById('deathStats');
    const btnReplay = document.getElementById('btnReplay');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const waveMessage = document.getElementById('waveMessage');
    const joystickMove = document.getElementById('joystickMove');
    const joystickAim = document.getElementById('joystickAim');
    const stickMove = document.getElementById('stickMove');
    const stickAim = document.getElementById('stickAim');

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const PLAYER_RADIUS = 10;
    const ZOMBIE_RADIUS = 10;
    const TILE_SIZE = 40;

    let map = [];
    let MAP_ROWS = 0;
    let MAP_COLS = 0;

    let players = {};
    let zombies = {};
    let bullets = {};
    let myId = null;
    let myPseudo = "";
    let playerHealth = 100;
    let myKills = 0;
    let currentRound = 1;
    let isDead = false;
    let lobbyStarted = false;

    // Joystick states
    let moveVector = {x: 0, y: 0};
    let aimVector = {x: 0, y: 0};

    // Adjust zoom level for mobile (less zoomed out)
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    let cameraZoom = isMobile ? 0.7 : 1;

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // Draw functions (map, players, zombies, bullets) remain unchanged

    // Joystick helper functions (setup + touch handling)
    function setupJoysticks() {
      if (!isMobile) {
        joystickMove.style.display = 'none';
        joystickAim.style.display = 'none';
        return;
      }
      joystickMove.style.display = 'block';
      joystickAim.style.display = 'block';

      // Position joysticks a bit higher and further from edges
      joystickMove.style.bottom = "140px";
      joystickMove.style.left = "40px";
      joystickAim.style.bottom = "140px";
      joystickAim.style.right = "40px";

      setupJoystick(joystickMove, stickMove, vec => {
        moveVector = vec;
      });
      setupJoystick(joystickAim, stickAim, vec => {
        aimVector = vec;
      });
    }

    function setupJoystick(container, stick, onChange) {
      let dragging = false;
      let startX, startY;
      const maxRadius = container.clientWidth / 2;

      function handleMove(clientX, clientY) {
        let dx = clientX - startX;
        let dy = clientY - startY;
        let dist = Math.sqrt(dx*dx + dy*dy);
        if (dist > maxRadius) {
          dx = dx / dist * maxRadius;
          dy = dy / dist * maxRadius;
          dist = maxRadius;
        }
        stick.style.transform = `translate(${dx}px, ${dy}px)`;
        onChange({x: dx / maxRadius, y: dy / maxRadius});
      }

      container.addEventListener('touchstart', e => {
        e.preventDefault();
        dragging = true;
        const touch = e.targetTouches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        stick.style.transition = 'none';
      });

      container.addEventListener('touchmove', e => {
        if (!dragging) return;
        e.preventDefault();
        const touch = e.targetTouches[0];
        handleMove(touch.clientX, touch.clientY);
      });

      container.addEventListener('touchend', e => {
        dragging = false;
        stick.style.transition = 'transform 0.3s ease';
        stick.style.transform = 'translate(0, 0)';
        onChange({x: 0, y: 0});
      });
    }

    // Socket.io setup
    const socket = io();

    socket.on('connect', () => {
      myId = socket.id;
    });

    // Input sending with throttling
    let lastMoveSend = 0;
    let lastShootSend = 0;
    function sendInputs() {
      const now = Date.now();

      if (now - lastMoveSend > 40) {
        socket.emit('playerInput', moveVector);
        lastMoveSend = now;
      }

      if (now - lastShootSend > 40) {
        socket.emit('playerShoot', aimVector);
        lastShootSend = now;
      }
    }
    setInterval(sendInputs, 40);

    // Remove previous auto-shoot on PC: shoot only on mouse click

    // PC Mouse input for aiming and shooting
    let mouseDown = false;
    let mousePos = {x: 0, y: 0};

    canvas.addEventListener('mousedown', e => {
      mouseDown = true;
    });
    canvas.addEventListener('mouseup', e => {
      mouseDown = false;
    });
    canvas.addEventListener('mousemove', e => {
      mousePos = {x: e.clientX, y: e.clientY};
    });

    function updatePCInputs() {
      if (!lobbyStarted || isDead) return;
      // Movement keys handled below
      if (mouseDown && players[myId]) {
        const p = players[myId];
        const cx = p.x - cameraX;
        const cy = p.y - cameraY;
        let aimX = mousePos.x - cx;
        let aimY = mousePos.y - cy;
        let dist = Math.sqrt(aimX*aimX + aimY*aimY);
        if (dist > 0) {
          aimX /= dist; aimY /= dist;
          socket.emit('playerShoot', { x: aimX, y: aimY });
        }
      } else {
        socket.emit('playerShoot', { x: 0, y: 0 });
      }
    }

    // Keyboard input
    let keys = {};
    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    function sendMoveInput(dx, dy) {
      socket.emit('playerInput', {x: dx, y: dy});
    }

    // Camera and rendering logic (adjusted for zoom) omitted for brevity

    // Lobby, game events handlers, drawing, HUD update logic remain mostly unchanged, except:

    socket.on('lobbyUpdate', (data) => {
      lobbyData = data;
      updateLobbyTexts();
      if (data.started) {
        lobbyStarted = true;
        lobbyScreen.style.display = 'none';
      }
    });

    socket.on('gameStarted', (data) => {
      players = data.players;
      map = data.map;
      MAP_ROWS = map.length;
      MAP_COLS = map[0].length;
      currentRound = data.round || 1;
      lobbyStarted = true;
      lobbyScreen.style.display = 'none';
      playerHealth = players[myId]?.health || 100;
      isDead = false;
      setupJoysticks();
      startGameLoop();
    });

    socket.on('playersHealthUpdate', (data) => {
      players = data;
      if (players[myId]) playerHealth = players[myId].health;
      drawHUD();
    });

    // Remaining socket events: zombiesUpdate, bulletsUpdate, killsUpdate, youDied, waveMessage
    socket.on('zombiesUpdate', (z) => {
      zombies = z;
    });

    socket.on('bulletsUpdate', (b) => {
      bullets = b;
    });

    socket.on('killsUpdate', (kills) => {
      myKills = kills;
      drawHUD();
    });

    socket.on('youDied', (data) => {
      isDead = true;
      playerHealth = 0;
      showDeathScreen(data.kills, data.round);
    });

    socket.on('waveMessage', (msg) => {
      waveMessage.textContent = msg;
      waveMessage.style.opacity = '1';
      setTimeout(() => {
        waveMessage.style.opacity = '0';
      }, 2500);
    });

    function update(deltaTime) {
      if (!lobbyStarted || isDead || !players[myId] || !players[myId].alive) return;

      // PC Keyboard movement
      if (!isMobile) {
        let dx = 0, dy = 0;
        if (keys['w'] || keys['arrowup']) dy -= 1;
        if (keys['s'] || keys['arrowdown']) dy += 1;
        if (keys['a'] || keys['arrowleft']) dx -= 1;
        if (keys['d'] || keys['arrowright']) dx += 1;
        if (dx !== 0 || dy !== 0) {
          let len = Math.sqrt(dx*dx + dy*dy);
          dx /= len;
          dy /= len;
          socket.emit('playerInput', {x: dx, y: dy});
        } else {
          socket.emit('playerInput', {x: 0, y: 0});
        }
        updatePCInputs();
      }
    }

    function drawLineOfSight() {
      if (!players[myId] || !players[myId].alive) return;
      const p = players[myId];
      if (isMobile) {
        if (aimVector.x === 0 && aimVector.y === 0) return;
        const startX = p.x - cameraX;
        const startY = p.y - cameraY;
        const endX = startX + aimVector.x * 160; // 2x longer line
        const endY = startY + aimVector.y * 160;
        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
      } else {
        if (!mouseDown) return;
        const startX = p.x - cameraX;
        const startY = p.y - cameraY;
        const mx = mousePos.x;
        const my = mousePos.y;
        const dx = mx - canvas.width/2;
        const dy = my - canvas.height/2;
        let len = Math.sqrt(dx*dx + dy*dy);
        if (len === 0) return;
        const nx = dx / len;
        const ny = dy / len;
        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(startX + nx * 160, startY + ny * 160);
        ctx.stroke();
      }
    }

    function gameLoop(timestamp = 0) {
      const deltaTime = Math.min(0.05, (timestamp - lastTime) / 1000);
      lastTime = timestamp;
      update(deltaTime);
      updateCamera();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      drawBullets();
      drawZombies();
      drawPlayers();
      drawLineOfSight();
      drawHUD();
      if (!isDead) requestAnimationFrame(gameLoop);
    }

    let lastTime = 0;
    function startGameLoop() {
      lastTime = performance.now();
      requestAnimationFrame(gameLoop);
    }

    // Initialize
    setupJoysticks();
    drawHUD();

    // Lobby UI handlers
    lobbyJoin.onclick = () => {
      const pseudo = pseudoInput.value.trim();
      if (!pseudo.match(/^[A-Za-z0-9]{1,15}$/)) {
        pseudoInput.style.background = "#fdd";
        setTimeout(() => pseudoInput.style.background = "", 600);
        return;
      }
      socket.emit('setPseudoAndReady', pseudo);
      myPseudo = pseudo;
      lobbyJoined = true;
      lobbyJoin.disabled = true;
      pseudoInput.disabled = true;
      lobbyJoin.textContent = TRANSLATIONS[currentLang].waiting;
    };

    pseudoInput.onkeydown = (e) => {
      if (e.key === "Enter") lobbyJoin.click();
    };

    // Language selector, HUD updates, and other UI remain unchanged

  </script>
</body>
</html>
