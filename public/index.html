<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Zombination.io</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #222; color: white; font-family: Arial, sans-serif; }
    #gameCanvas { display: block; background: #222; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; }
	#gameCanvas { touch-action: none; }
	.joystick-base, .joystick-stick { touch-action: none; }
	html, body { overscroll-behavior: none; }

	/* Bloque le ‚Äúpull to refresh‚Äù et le rebond */
	html, body { overscroll-behavior: none; }
    #hudStats { position: fixed; left: 10px; bottom: 10px; background: rgba(0,0,0,0.7); border-radius: 7px; padding: 10px 20px 10px 15px; font-size: 18px; user-select: none; min-width: 210px; }
    #hudAlive { font-weight: bold; color: #fd7; }
    #deathScreen { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(30,0,0,0.8); z-index: 3; justify-content: center; align-items: center; flex-direction: column; }
    #deathScreenInner { background: #181818; border-radius: 20px; padding: 35px 45px; color: #fff; box-shadow: 0 6px 30px #000c; text-align: center; min-width: 320px; }
    #deathScreen h2 { margin: 0 0 15px 0; color: #fc2c3c; }
    #deathStats { margin-bottom: 15px; font-size: 20px; }
    #btnReplay { background: #222; color: #fff; padding: 10px 32px; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; transition: background 0.16s; }
    #btnReplay:hover { background: #393; color: #fff; }
    /* --- LOBBY --- */
    #lobbyScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; left:0;top:0;width:100vw;height:100vh;z-index:10; background: #181c; }
    #lobbyBox { background: #19191e; border-radius: 20px; padding: 36px 42px; box-shadow: 0 6px 30px #000c; min-width: 350px; min-height: 190px; text-align: center; }
    #lobbyBox input[type=text] { font-size: 20px; padding: 7px 12px; border-radius: 7px; border: 1px solid #444; outline: none; margin-bottom: 10px; width: 175px; }
    #lobbyJoin { padding: 7px 32px; border-radius: 8px; border:none; font-size: 20px; background:#49c749; color: #fff; cursor: pointer; margin-top: 7px; }
    #lobbyJoin[disabled] { opacity: 0.6; cursor: not-allowed; }
    #lobbyPlayers { margin: 18px 0 12px 0; color: #9fd; }
    #lobbyTimer { font-size: 17px; margin-bottom: 9px; }
    #lobbyStatus { margin: 4px 0 0 0; color: #ccc; font-size: 14px; }

    /* --- LANG SELECT --- */
    #langSelectRow {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      gap: 13px;
      user-select: none;
    }
    .langFlag {
      width: 38px;
      height: 26px;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border 0.14s, transform 0.12s;
      background: #fff2;
      object-fit: cover;
      box-shadow: 0 2px 10px #0003;
    }
    .langFlag.selected {
      border: 2.5px solid #33fc69;
      transform: scale(1.07);
      box-shadow: 0 2px 16px #33fc6930;
    }

    /* --- WAVE MESSAGE --- */
    #waveMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #f2f263;
      font-size: 48px;
      font-weight: bold;
      text-shadow: 2px 2px 6px #000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
      z-index: 20;
      user-select: none;
    }
    /* Version */
    #versionBox {
      position: fixed;
      right: 20px;
      bottom: 14px;
      color: #ccc;
      font-size: 14px;
      opacity: 0.8;
      z-index: 20;
      user-select: none;
    }
    /* Ajout des joysticks mobile */
    .joystick-container {
      position: fixed;
      z-index: 50;
      touch-action: none;
      pointer-events: none;
    }
    .joystick-base, .joystick-stick {
      pointer-events: auto;
      user-select: none;
    }
	#shopModal {
	  animation: shopPopIn 0.22s;
	  backdrop-filter: blur(0.5px);
	  -webkit-overflow-scrolling: touch; /* ‚Üê Ajout ici */
	}

	#shopModal:focus-within { outline: 2px solid #4dfc82; }
	#shopModal::-webkit-scrollbar { width: 6px; }
	#shopModal::-webkit-scrollbar-thumb { background: #2a5; border-radius: 4px; }
	@keyframes shopPopIn {
	  0% { opacity: 0; transform: translateY(80px) scale(0.97);}
	  100% { opacity: 1; transform: none; }
	}
	#shopClose:hover { color: #ff6464; transform: scale(1.13); }
	.bought-flash {
	  animation: flashBtn 0.22s;
	}
	@keyframes flashBtn {
	  0% { box-shadow: 0 0 0px #67fa62, 0 0 0px #fff; background: #34c24c;}
	  55% { box-shadow: 0 0 11px #67fa62, 0 0 22px #fff9;}
	  100% { box-shadow: 0 0 0px #67fa62, 0 0 0px #fff; }
	}
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hudStats">
    <div id="hudAlive"></div>
	<div id="hudMoney"></div>
    <div id="hudZombies"></div>
    <div id="hudKills"></div>
    <div id="hudRound"></div>
    <div id="hudHP"></div>
  </div>
  <div id="deathScreen">
    <div id="deathScreenInner">
      <h2 id="deathTitle"></h2>
      <div id="deathStats"></div>
      <button id="btnReplay"></button>
    </div>
  </div>
  <div id="lobbyScreen">
    <div id="lobbyBox">
      <div id="lobbyTitle" style="font-size: 28px; margin-bottom: 18px;"><b>Zombination.io</b></div>
      <div id="lobbyPlayers"></div>
      <div id="lobbyTimer"></div>
      <div id="lobbyStatus"></div>
      <input type="text" id="pseudoInput" maxlength="15" placeholder="" />
      <br>
      <button id="lobbyJoin"></button>
      <div id="langSelectRow"></div>
    </div>
  </div>
	 <button id="shopBtn" title="Boutique" style="display: flex; align-items: center; position: fixed; right: 20px; bottom: 52px; z-index: 21; background: #232; color: #fff; border-radius: 13px; border: none; font-size: 22px; padding: 10px 26px 10px 19px; box-shadow: 0 2px 14px #0006; cursor: pointer; gap: 13px; transition: background 0.17s;">
	  <img src="/icons/cart.svg" alt="Shop" style="width: 27px; height: 27px; margin-right: 8px; filter: brightness(1.25) drop-shadow(0 2px 5px #0006);" />
	  SHOP
	</button>
	<div id="shopModal" style="display:none; position:fixed; right:34px; bottom:90px; z-index:25; background:#181e19ee; border-radius:18px; box-shadow:0 8px 28px #000c; min-width:340px; min-height:280px; padding:32px 26px 22px 26px;">
	  <button id="shopClose" style="position:absolute; right:17px; top:10px; background:none; border:none; color:#fff; font-size:26px; cursor:pointer; filter:drop-shadow(0 2px 6px #0009);">‚úï</button>
	  <div style="font-size:26px; margin-bottom:15px; display:flex; align-items:center; gap:10px;">
		<img src="/icons/cart.svg" alt="Shop" style="width:30px; filter:brightness(1.2); vertical-align:middle;">
		<span>SHOP</span>
	  </div>
	  <div id="shopUpgrades">
		<!-- Ici viendront les lignes d‚Äôam√©liorations √† l‚Äô√©tape suivante -->
		<div style="color:#fff6; font-size:17px; margin-top:18px;">Boutique √† venir¬†: <i>Affichage des am√©liorations ici √† l‚Äô√©tape 3</i></div>
	  </div>
	</div>
  <div id="versionBox">Version 1.0.0 par Myg</div>
  <div id="waveMessage"></div>
  <script src="/translations.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  window.addEventListener('contextmenu', e => e.preventDefault(), { passive: false });
    // --- LANG/LOBBY ---
    const LANGS = [
      { code: 'en', flag: 'gb.png', label: 'English' },
      { code: 'cn', flag: 'cn.png', label: '‰∏≠Êñá' },
      { code: 'ru', flag: 'ru.png', label: '–†—É—Å—Å–∫–∏–π' },
      { code: 'es', flag: 'es.png', label: 'Espa√±ol' },
      { code: 'pt', flag: 'pt.png', label: 'Portugu√™s' },
      { code: 'de', flag: 'de.png', label: 'Deutsch' },
      { code: 'jp', flag: 'jp.png', label: 'Êó•Êú¨Ë™û' },
      { code: 'fr', flag: 'fr.png', label: 'Fran√ßais' },
      { code: 'pl', flag: 'pl.png', label: 'Polski' },
      { code: 'kr', flag: 'kr.png', label: 'ÌïúÍµ≠Ïñ¥' }
    ];
    function getDefaultLang() { return "en"; }
    let currentLang = getDefaultLang();
    let lobbyData = { started: false, count: 0, max: 5, timeLeft: 30, players: {} };
    let lobbyJoined = false, lobbyStarted = false;
    function initLobbyTexts() {
      updateLobbyTexts();
      pseudoInput.placeholder = TRANSLATIONS[currentLang].enterPseudo;
      lobbyJoin.textContent = TRANSLATIONS[currentLang].join;
    }
    function updateLobbyTexts() {
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      lobbyPlayers.textContent = `${tr.playersInGame} : ${lobbyData.count}/${lobbyData.max}`;
      lobbyTimer.textContent = `${tr.timeLeft} : ${lobbyData.timeLeft}s`;
      const readyCount = Object.values(lobbyData.players).filter(p=>p.ready).length;
      lobbyStatus.textContent = `${tr.waitingStart} (${readyCount} ${tr.playersReady}${readyCount>1?'s':''})`;
    }
    function updateUITexts() {
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      document.getElementById('lobbyTitle').innerHTML = `<b>${tr.zombination}</b>`;
      pseudoInput.placeholder = tr.enterPseudo;
      lobbyJoin.textContent = lobbyJoined ? tr.waiting : tr.join;
      document.getElementById('deathTitle').textContent = tr.youDied;
      btnReplay.textContent = tr.replay;
      if (!lobbyStarted) { updateLobbyTexts(); }
    }
    const langSelectRow = document.getElementById('langSelectRow');
    function renderLangFlags() {
      langSelectRow.innerHTML = '';
      LANGS.forEach(lang => {
        const img = document.createElement('img');
        img.src = `/flags/${lang.flag}`;
        img.alt = lang.label;
        img.title = lang.label;
        img.className = 'langFlag' + (lang.code === currentLang ? ' selected' : '');
        img.onclick = () => {
          if (currentLang !== lang.code) {
            currentLang = lang.code;
            renderLangFlags(); updateUITexts(); drawHUD();
          }
        };
        langSelectRow.appendChild(img);
      });
    }
    const pseudoInput = document.getElementById('pseudoInput');
	pseudoInput.addEventListener('input', function() {
	  this.value = this.value.replace(/[^a-zA-Z0-9]/g, '');
	});

    const lobbyJoin = document.getElementById('lobbyJoin');
    const lobbyPlayers = document.getElementById('lobbyPlayers');
    const lobbyTimer = document.getElementById('lobbyTimer');
    const lobbyStatus = document.getElementById('lobbyStatus');
    const deathTitle = document.getElementById('deathTitle');
    const deathStats = document.getElementById('deathStats');
    const btnReplay = document.getElementById('btnReplay');
    renderLangFlags(); initLobbyTexts();

    // --- JEU ---
    const socket = io();
	setInterval(() => {
	  if (socket && socket.connected) {
		socket.emit('clientPing');
	  }
	}, 10000); // Toutes les 8 secondes (tu peux mettre 10000 pour 10s)
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hudAlive = document.getElementById('hudAlive');
    const hudZombies = document.getElementById('hudZombies');
    const hudKills = document.getElementById('hudKills');
    const hudRound = document.getElementById('hudRound');
    const hudHP = document.getElementById('hudHP');
	const hudMoney = document.getElementById('hudMoney');
	let myMoney = 10;
	// --- UPGRADES CONFIG ---
	const UPGRADES = [
	  {
		id: "maxHp",    // identifiant interne
		label: "+10% Vie max",
		desc: "Augmente les PV max.",
		icon: "/icons/heart.svg",
		getValue: (base, level) => Math.round(base * Math.pow(1.1, level)),
		baseValue: 100,
		statLabel: "PV max",
		format: v => v + " PV"
	  },
	  {
		id: "speed",
		label: "+10% Vitesse",
		desc: "D√©place-toi plus vite.",
		icon: "/icons/speed.svg",
		getValue: (base, level) => +(base * Math.pow(1.1, level)).toFixed(1),
		baseValue: 60,
		statLabel: "Vitesse",
		format: v => v + " px/s"
	  },
	  {
		id: "regen",
		label: "+0.25 PV/s regen",
		desc: "R√©g√©n√®re tes PV chaque seconde.",
		icon: "/icons/regen.svg",
		getValue: (base, level) => +(base + 0.25 * level).toFixed(2),
		baseValue: 0,
		statLabel: "R√©g√©n.",
		format: v => v + " PV/s"
	  },
	  {
		id: "damage",
		label: "+10% D√©g√¢ts",
		desc: "Tire plus fort.",
		icon: "/icons/bullet.svg",
		getValue: (base, level) => Math.round(base * Math.pow(1.1, level)),
		baseValue: 5,
		statLabel: "D√©g√¢ts",
		format: v => v
	  },
		{
		  id: "goldGain",
		  label: "+10% d'or gagn√©",
		  desc: "Gagne plus d‚Äôor sur les zombies.",
		  icon: "/icons/gold.svg",
		  getValue: (base, level) => Math.round(base * Math.pow(1.1, level)),
		  baseValue: 10, // car goldGain commence √† 10 c√¥t√© serveur !
		  statLabel: "$/zombie",
		  format: (v) => {
			const min = Math.round(10 * (v / 10));
			const max = Math.round(20 * (v / 10));
			return `$${min}‚Äì${max}`;
		  }
		}
	];

	// Niveau des upgrades du joueur local (simul√© pour l‚Äôinstant)
	let myUpgrades = {
	  maxHp: 0,
	  speed: 0,
	  regen: 0,
	  damage: 0,
	  goldGain: 0
	};

    const waveMessage = document.getElementById('waveMessage');
    let currentRound = 1, playersHealth = {}, zombies = {}, bullets = {};
    let myId = null, playerHealth = 100, isDead = false, myKills = 0, myPseudo = "";
	let moneyFloatingTexts = []; // Pour stocker les "+$" √† afficher

    // D√©tection mobile
    function isMobile() { return /android|iphone|ipad|ipod|opera mini|iemobile|mobile/i.test(navigator.userAgent); }
    const isMobileDevice = isMobile();
	// === [ZOOM MOBILE PAYSAGE] ===
	let renderScale = 1;
	function updateRenderScale() {
	  const isLandscape = isMobileDevice && window.matchMedia('(orientation: landscape)').matches;
	  renderScale = isLandscape ? 0.62 : 1; // encore + large (essaie 0.60 si tu veux ultra-large)
	}

	updateRenderScale();
    const PLAYER_SPEED_PER_SEC = 60;
    const TILE_SIZE = 40;
    const PLAYER_RADIUS = 10;
    const ZOMBIE_RADIUS = 10;
    let map = [], MAP_ROWS = 0, MAP_COLS = 0;
    let cameraX = 0, cameraY = 0;
    const keys = {};
    let mouseDown = false, mousePos = { x: 0, y: 0 };
    let aimDir = { x: 1, y: 0 }; // direction de vis√©e par d√©faut (droite)

	window.addEventListener('keydown', e => {
	  if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
		e.preventDefault(); // √©vite le scroll de la page !
	  }
	  keys[e.key.toLowerCase()] = true;
	});
	window.addEventListener('keyup', e => {
	  if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
		e.preventDefault();
	  }
	  keys[e.key.toLowerCase()] = false;
	});
	
    window.addEventListener('mousedown', e => { mouseDown = e.button === 0; });
    window.addEventListener('mouseup', e => { if (e.button === 0) mouseDown = false; });
    window.addEventListener('mousemove', e => {
      mousePos = { x: e.clientX, y: e.clientY };
      if (!isMobileDevice && myId && playersHealth[myId]) {
        const player = playersHealth[myId];
        aimDir = {
          x: (cameraX + mousePos.x) - player.x,
          y: (cameraY + mousePos.y) - player.y
        };
        let len = Math.hypot(aimDir.x, aimDir.y);
        if (len > 0) {
          aimDir.x /= len;
          aimDir.y /= len;
        }
      }
    });
    function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // JOYSTICK PATCH MOBILE
    let moveJoy = null, aimJoy = null;
	let moveJoyVal = {x:0, y:0}, aimJoyVal = {x:0, y:0}; // valeurs normalis√©es [-1..1]
    function createJoystick(container, baseX, baseY, id) {
      const size = Math.floor(Math.min(window.innerWidth, window.innerHeight) * 0.23);
      const joyDiv = document.createElement('div');
      joyDiv.className = 'joystick-container';
      joyDiv.style.left = baseX + 'px';
      joyDiv.style.top = baseY + 'px';
      joyDiv.style.width = size + 'px';
      joyDiv.style.height = size + 'px';
      joyDiv.id = id;
      joyDiv.style.pointerEvents = 'none';
      document.body.appendChild(joyDiv);
      const base = document.createElement('div');
      base.className = 'joystick-base';
      base.style.width = size + 'px';
      base.style.height = size + 'px';
      base.style.background = 'rgba(255,255,255,0.12)';
      base.style.borderRadius = '50%';
      base.style.position = 'absolute';
      base.style.left = '0px'; base.style.top = '0px';
      base.style.pointerEvents = 'auto';
      joyDiv.appendChild(base);
      const stick = document.createElement('div');
      stick.className = 'joystick-stick';
      stick.style.width = (size*0.52) + 'px';
      stick.style.height = (size*0.52) + 'px';
      stick.style.background = 'rgba(160,255,240,0.45)';
      stick.style.borderRadius = '50%';
      stick.style.position = 'absolute';
      stick.style.left = (size*0.24) + 'px';
      stick.style.top = (size*0.24) + 'px';
      stick.style.pointerEvents = 'auto';
      joyDiv.appendChild(stick);
      return { joyDiv, base, stick, size };
    }

// === Handlers de joystick ===
function addJoystickHandlers(joy, which) {
  const size = joy.size;
  const radius = size / 2;
  const stickRadius = (size * 0.52) / 2;
  const center = { x: radius, y: radius };

  let activeId = null;

	function setVec(dx, dy) {
	  const max = radius - stickRadius;
	  const len = Math.hypot(dx, dy);

	  // clamp visuel du stick
	  let nx = dx, ny = dy;
	  if (len > max && len > 0) {
		nx = dx * (max / len);
		ny = dy * (max / len);
	  }

	  // positionne le stick √† l‚Äô√©cran
	  joy.stick.style.left = (center.x - stickRadius + nx) + "px";
	  joy.stick.style.top  = (center.y - stickRadius + ny) + "px";

	  // vecteur normalis√© [-1..1] pour la logique
	  // (plus fluide/sensible, pas de Math.round)
	  const out = (max > 0) ? { x: nx / max, y: ny / max } : { x: 0, y: 0 };

	  if (which === "move") moveJoyVal = out;
	  else aimJoyVal = out;
	}


  function reset() {
    activeId = null;
    setVec(0, 0);
  }

  function localCoords(clientX, clientY) {
    const r = joy.joyDiv.getBoundingClientRect();
    return { x: clientX - r.left, y: clientY - r.top };
  }

  function onDown(e) {
    if (activeId !== null) return;
    activeId = e.pointerId;
    joy.base.setPointerCapture(activeId);
    const p = localCoords(e.clientX, e.clientY);
    setVec(p.x - center.x, p.y - center.y);
    e.preventDefault();
  }

  function onMove(e) {
    if (e.pointerId !== activeId) return;
    const p = localCoords(e.clientX, e.clientY);
    setVec(p.x - center.x, p.y - center.y);
    e.preventDefault();
  }

  function onUp(e) {
    if (e.pointerId !== activeId) return;
    joy.base.releasePointerCapture(activeId);
    reset();
    e.preventDefault();
  }

  // listeners
  joy.base.addEventListener('pointerdown', onDown, { passive: false });
  window.addEventListener('pointermove', onMove, { passive: false });
  window.addEventListener('pointerup', onUp, { passive: false });
  window.addEventListener('pointercancel', onUp, { passive: false });

  // d√©marrage centr√©
  reset();
}


function setupJoysticks() {
  if (!isMobileDevice) return;

  // Nettoyage
  if (moveJoy && moveJoy.joyDiv) moveJoy.joyDiv.remove();
  if (aimJoy && aimJoy.joyDiv) aimJoy.joyDiv.remove();

  const padding = 36;
  const joySize = Math.floor(Math.min(window.innerWidth, window.innerHeight) * 0.23);
  let joyY = window.innerHeight - joySize - padding;
  if (joyY < padding) joyY = padding;

  // Cr√©e les deux joysticks
  moveJoy = createJoystick(document.body, padding, joyY, "moveJoy");
  aimJoy  = createJoystick(document.body, window.innerWidth - joySize - padding, joyY, "aimJoy");
  
	addJoystickHandlers(moveJoy, "move");
	addJoystickHandlers(aimJoy, "aim");

  // IMPORTANT : repositionner le bouton + le panneau shop apr√®s cr√©ation/rotation
  positionShopUI();
}

function positionShopUI() {
  if (!isMobileDevice) return;
  const shopBtnEl = document.getElementById('shopBtn');
  const shopModalEl = document.getElementById('shopModal');
  if (!aimJoy || !aimJoy.joyDiv || !shopBtnEl) return;

  const isPortrait = window.matchMedia("(orientation: portrait)").matches;
  const joyRect = aimJoy.joyDiv.getBoundingClientRect();

	if (shopModalEl) {
	  const gap = isPortrait ? 28 : 12;
	  const availableHeightAboveJoystick = Math.max(0, joyRect.top - gap);
	  const margin = 10;

	  const maxH = Math.max(180, Math.min(availableHeightAboveJoystick - margin, window.innerHeight - 2*margin));
	  shopModalEl.style.maxHeight = maxH + "px";
	  shopModalEl.style.overflowY = "auto";

	  if (!isPortrait) {
		shopModalEl.style.minWidth = "300px";
		shopModalEl.style.maxWidth = Math.min(360, window.innerWidth - 20) + "px";
	  }

	  // üëâ ancrage horizontal √† droite du joystick
	  shopModalEl.style.right = (window.innerWidth - joyRect.right + 14) + "px";

	  // recalage vertical au-dessus du joystick
	  let computedBottom = (window.innerHeight - joyRect.top) + gap;
	  const minBottom = 8;
	  const maxBottom = window.innerHeight - 120;
	  if (computedBottom < minBottom) computedBottom = minBottom;
	  if (computedBottom > maxBottom) computedBottom = maxBottom;
	  shopModalEl.style.bottom = computedBottom + "px";
	}


  // --- Bouton SHOP au-dessus du joystick droit ---
  const btnGap = 20; // espace entre bouton et joystick
  shopBtnEl.style.position = "fixed";
  shopBtnEl.style.zIndex = "60";
  shopBtnEl.style.right  = (window.innerWidth - joyRect.right) + "px";
  shopBtnEl.style.bottom = (window.innerHeight - joyRect.top) + btnGap + "px";

  // --- Panneau SHOP : align√© √† droite du joystick, et assez haut pour ne pas chevaucher ---
}


function drawMap() {
  if (!map.length) return;
  const startCol = Math.floor(cameraX / TILE_SIZE);
  const startRow = Math.floor(cameraY / TILE_SIZE);
  const visibleCols = Math.ceil(canvas.width / TILE_SIZE) + 2;
  const visibleRows = Math.ceil(canvas.height / TILE_SIZE) + 2;

  for (let row = startRow; row < startRow + visibleRows; row++) {
    if (row < 0 || row >= MAP_ROWS) continue;
    for (let col = startCol; col < startCol + visibleCols; col++) {
      if (col < 0 || col >= MAP_COLS) continue;
      if (map[row][col] === 1) {
        ctx.fillStyle = '#363636';
        ctx.fillRect(
          col * TILE_SIZE - cameraX,
          row * TILE_SIZE - cameraY,
          TILE_SIZE,
          TILE_SIZE
        );
      }
    }
  }
}

	function drawPlayers() {
	  for (const id in playersHealth) {
		const p = playersHealth[id];
		if (!p.alive) continue;
		const screenX = p.x - cameraX;
		const screenY = p.y - cameraY;
		ctx.beginPath();
		ctx.fillStyle = (id === myId) ? 'lime' : '#cfc';
		ctx.arc(screenX, screenY, PLAYER_RADIUS, 0, Math.PI * 2);
		ctx.fill();
		ctx.font = "bold 17px Arial";
		ctx.textAlign = "center";
		ctx.fillStyle = "#aad8ff";
		ctx.fillText(p.pseudo || "Joueur", screenX, screenY - PLAYER_RADIUS - 22);
		// <-- largeur fixe 30 pour joueur
		drawHealthBar(
		  screenX,
		  screenY - PLAYER_RADIUS - 13,
		  p.health,
		  p.maxHealth || 100,
		  30
		);
	  }
	}
    function drawZombies() {
      for (const id in zombies) {
        const z = zombies[id];
        const screenX = z.x - cameraX;
        const screenY = z.y - cameraY;
        ctx.beginPath();
        ctx.fillStyle = 'red';
        ctx.arc(screenX, screenY, ZOMBIE_RADIUS, 0, Math.PI * 2);
        ctx.fill();
        drawHealthBar(screenX, screenY - ZOMBIE_RADIUS - 10, z.hp, z.maxHp);
      }
    }
    function drawBullets() {
      for (const id in bullets) {
        const b = bullets[id];
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = (b.owner === myId) ? 'yellow' : '#ff0';
        ctx.lineWidth = 3;
        ctx.moveTo(b.x - cameraX, b.y - cameraY);
        ctx.lineTo(
          b.x - cameraX - b.dx * 8,
          b.y - cameraY - b.dy * 8
        );
        ctx.stroke();
        ctx.restore();
      }
    }
	
	function drawMoneyFloatingTexts() {
	  const now = Date.now();
	  for (let i = moneyFloatingTexts.length - 1; i >= 0; i--) {
		const f = moneyFloatingTexts[i];
		const t = (now - f.time);
		if (t > f.duration) {
		  moneyFloatingTexts.splice(i, 1); // On le retire
		  continue;
		}
		// Position √©cran
		const screenX = f.x - cameraX;
		const screenY = f.y - cameraY + f.vy * t;

		ctx.save();
		ctx.globalAlpha = 1 - (t / f.duration); // Fade out progressif
		ctx.font = "bold 28px Arial";
		ctx.textAlign = "center";
		ctx.lineWidth = 3;
		ctx.strokeStyle = "#222";
		ctx.strokeText(`+${f.amount}$`, screenX, screenY);
		ctx.fillStyle = "#32ff72";
		ctx.fillText(`+${f.amount}$`, screenX, screenY);
		ctx.restore();
	  }
	}

	function drawHealthBar(x, y, current, max, width = null, height = 5) {
	  let w;
	  if (width !== null) {
		w = width;  // largeur fix√©e explicitement
	  } else {
		// largeur variable pour zombies, par exemple
		w = Math.max(30, Math.min(70, 30 + (max - 10) * 0.7));
	  }
	  const ratio = Math.max(0, Math.min(1, current / max));
	  ctx.fillStyle = '#111';
	  ctx.fillRect(x - w / 2, y, w, height);
	  ctx.fillStyle = (ratio < 0.4) ? "#e66" : "#8f8";
	  ctx.fillRect(x - w / 2, y, w * ratio, height);
	  ctx.strokeStyle = '#fff';
	  ctx.strokeRect(x - w / 2, y, w, height);
	}

    // ---- TRAIT DE VIS√âE PATCH ----
	function drawAimLine() {
	  if (!myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
	  const player = playersHealth[myId];
	  let dir = {x: 1, y: 0};
	  let show = false;

		if (isMobileDevice) {
		  let len = Math.hypot(aimJoyVal.x, aimJoyVal.y);
		  if (len > 0.06) { // deadzone faible coh√©rente avec update()
			dir = { x: aimJoyVal.x/len, y: aimJoyVal.y/len };
			show = true;
		  }
		}
		else {
		if (mouseDown) {  // sur PC, afficher **uniquement** quand on tire
		  let dx = (cameraX + mousePos.x) - player.x;
		  let dy = (cameraY + mousePos.y) - player.y;
		  let dist = Math.sqrt(dx*dx + dy*dy);
		  if (dist > 3) {
			dir = { x: dx / dist, y: dy / dist };
			show = true;
		  }
		}
	  }

	  if (!show) return;

	  const length = 440; // double taille de la barre (au lieu de 220)
	  const screenX = player.x - cameraX;
	  const screenY = player.y - cameraY;

	  ctx.save();
	  ctx.beginPath();
	  ctx.moveTo(screenX, screenY);
	  ctx.lineTo(screenX + dir.x * length, screenY + dir.y * length);
	  ctx.strokeStyle = 'rgba(255,255,0,0.66)';
	  ctx.lineWidth = 2;
	  ctx.shadowColor = 'yellow';
	  ctx.shadowBlur = 7;
	  ctx.stroke();
	  ctx.restore();
	}
	
	function update(deltaTime) {
	  if (isDead || !myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
	  let player = playersHealth[myId];
	  let move = { x:0, y:0 };

	  // ---- MOUVEMENT ----
	  if (!isMobileDevice) {
		if (keys['arrowup'] || keys['w']) move.y -= 1;
		if (keys['arrowdown'] || keys['s']) move.y += 1;
		if (keys['arrowleft'] || keys['a']) move.x -= 1;
		if (keys['arrowright'] || keys['d']) move.x += 1;
	  } else {
		const len = Math.hypot(moveJoyVal.x, moveJoyVal.y);
		if (len > 0.06) {  // deadzone tr√®s faible ‚Üí plus sensible
		  move.x = moveJoyVal.x / (len || 1);
		  move.y = moveJoyVal.y / (len || 1);
		}
	  }

	  socket.emit('moveDir', move);

	  // ---- TIR ----
	  let shooting = false;
	  let shootDir = { x:1, y:0 };

	  if (!isMobileDevice) {
		let dx = (cameraX + mousePos.x) - player.x;
		let dy = (cameraY + mousePos.y) - player.y;
		let len = Math.hypot(dx, dy);
		if (len > 3) shootDir = { x: dx/len, y: dy/len };
		shooting = mouseDown;
	  } else {
		const len = Math.hypot(aimJoyVal.x, aimJoyVal.y);
		if (len > 0.06) { // m√™me deadzone faible
		  shootDir = { x: aimJoyVal.x / (len || 1), y: aimJoyVal.y / (len || 1) };
		  shooting = true; // d√®s qu‚Äôon pousse un peu, on tire
		}
	  }

	  if (shooting && !shootBlocked) {
		shootBlocked = true;
		socket.emit('shoot', {
		  targetX: player.x + shootDir.x * 120,
		  targetY: player.y + shootDir.y * 120
		});
		setTimeout(() => { shootBlocked = false; }, 300); // cadence un peu plus rapide
	  }
	}


    let shootBlocked = false;

	function updateCamera() {
	  if (!myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
	  let player = playersHealth[myId];

	  const viewW = canvas.width / renderScale;
	  const viewH = canvas.height / renderScale;

	  cameraX = player.x - viewW / 2;
	  cameraY = player.y - viewH / 2;

	  cameraX = Math.max(0, Math.min(cameraX, MAP_COLS * TILE_SIZE - viewW));
	  cameraY = Math.max(0, Math.min(cameraY, MAP_ROWS * TILE_SIZE - viewH));
	}


	function drawHUD() {
	  const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
	  const aliveCount = Object.values(playersHealth).filter(p => p.alive).length;
	  hudAlive.textContent = `${tr.alive} : ${aliveCount}`;
	  hudMoney.textContent = `Money : $${myMoney}`; // <-- AJOUT ICI
	  hudZombies.textContent = `${tr.zombiesLeft}: ${Object.keys(zombies).length}`;
	  hudKills.textContent = `${tr.kills}: ${myKills}`;
	  hudRound.textContent = `${tr.round}: ${currentRound}`;
		const me = playersHealth[myId];
		hudHP.textContent = me && me.maxHealth
		  ? `${tr.health}: ${Math.round(me.health)} / ${me.maxHealth}`
		  : `${tr.health}: ${Math.round(me ? me.health : 0)}`;
	}


    function showDeathScreen(kills = myKills, round = currentRound) {
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      deathStats.innerHTML = `${tr.zombiesKilled}: <b>${kills}</b><br>${tr.roundReached}: <b>${round}</b>`;
      deathScreen.style.display = 'flex';
    }
    btnReplay.onclick = () => { location.reload(); };

    let lastTime = 0;
    function gameLoop(timestamp = 0) {
      const deltaTime = Math.max(0.008, Math.min(0.05, (timestamp - lastTime) / 1000));
      lastTime = timestamp;
      update(deltaTime);
      updateCamera();
		// Remet la transform, clear, puis applique le scale (zoom)
		ctx.setTransform(1, 0, 0, 1, 0, 0);
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		ctx.setTransform(renderScale, 0, 0, renderScale, 0, 0);

		drawMap();
		drawBullets();
		drawZombies();
		drawMoneyFloatingTexts();
		drawPlayers();
		drawAimLine();

		// IMPORTANT : le HUD est en DOM, pas sur le canvas ‚Äî tu peux le laisser tel quel
		drawHUD();

      if (!isDead) requestAnimationFrame(gameLoop);
    }

    socket.on('connect', () => { myId = socket.id; });
    socket.on('lobbyUpdate', (data) => {
      lobbyData = {
        ...data,
        players: {...data.players}
      };
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      if (data.started) {
        lobbyScreen.style.display = 'none';
        lobbyStarted = true;
        return;
      }
      lobbyScreen.style.display = 'flex';
      updateLobbyTexts();
      lobbyJoin.disabled = lobbyJoined;
      pseudoInput.disabled = lobbyJoined;
      if (lobbyJoined) lobbyJoin.textContent = tr.waiting;
      else lobbyJoin.textContent = tr.join;
    });

    lobbyJoin.onclick = () => {
      if (!pseudoInput.value.trim()) {
        pseudoInput.focus();
        pseudoInput.style.background = "#fdd";
        setTimeout(() => pseudoInput.style.background = "", 600);
        return;
      }
      socket.emit('setPseudoAndReady', pseudoInput.value.trim());
      myPseudo = pseudoInput.value.trim();
      lobbyJoined = true;
      lobbyJoin.disabled = true;
      pseudoInput.disabled = true;
      lobbyJoin.textContent = TRANSLATIONS[currentLang].waiting;
    };

    pseudoInput.onkeydown = (e) => {
      if (e.key === "Enter") lobbyJoin.click();
    };

    socket.on('gameStarted', (data) => {
      map = data.map;
      MAP_ROWS = map.length;
      MAP_COLS = map[0].length;
      playersHealth = data.players;
      currentRound = data.round;
      lobbyScreen.style.display = 'none';
      isDead = false; playerHealth = 100; myKills = 0;
      if (isMobileDevice) setTimeout(setupJoysticks, 300);
      setTimeout(()=>{ gameLoop(); }, 400);
    });

    socket.on('zombiesUpdate', (z) => { zombies = z; });
    socket.on('bulletsUpdate', (b) => { bullets = b; });
    socket.on('killsUpdate', (kills) => { myKills = kills; drawHUD(); });
    socket.on('currentRound', (round) => { currentRound = round; drawHUD(); });

	socket.on('playersHealthUpdate', (players) => {
	  // Met √† jour toutes les infos re√ßues pour tous les joueurs
	for (const id in players) {
	  if (!playersHealth[id]) playersHealth[id] = {};
	  playersHealth[id].health = players[id].health;
	  playersHealth[id].alive = players[id].alive;
	  playersHealth[id].x = players[id].x;
	  playersHealth[id].y = players[id].y;
	  playersHealth[id].pseudo = players[id].pseudo || "Joueur";
	  playersHealth[id].money = players[id].money || 0;
	  playersHealth[id].maxHealth = players[id].maxHealth || 100;  // <--- AJOUTE CETTE LIGNE
	}

	  // Mets √† jour les variables du joueur local
	const me = players[socket.id];
	if (me) {
	  playerHealth = me.health;
	  myMoney = me.money || 0;
	  playersHealth[myId].maxHealth = me.maxHealth || 100; // <--- aussi ici pour √™tre s√ªr
	}
	});

    socket.on('youDied', (data) => {
      isDead = true;
      playerHealth = 0;
      showDeathScreen(data.kills, data.round);
    });

	socket.on('moneyEarned', ({ amount, x, y }) => {
	  // Position sur la map, converti en coordonn√©es √©cran pour affichage temporaire
	  moneyFloatingTexts.push({
		amount,
		x,
		y,
		time: Date.now(),
		duration: 1200, // ms
		vy: -0.14 // pixels/ms (vitesse vers le haut)
	  });
	});

    socket.on('waveMessage', (msg) => {
      waveMessage.textContent = msg;
      waveMessage.style.opacity = '1';
      setTimeout(() => { waveMessage.style.opacity = '0'; }, 2500);
    });

	socket.on('upgradeBought', ({ upgId, newLevel, newMoney }) => {
	  if (!upgId) return;
	  myUpgrades[upgId] = newLevel;
	  myMoney = newMoney;
	  renderShopUpgrades();
	  drawHUD();

	  // Trouve le bouton correspondant et applique l'animation
	  setTimeout(() => {
		const btn = document.querySelector(`#shopUpgrades button[data-upgid="${upgId}"]`);
		if (btn) {
		  btn.classList.remove('bought-flash'); // Si jamais d√©j√† pr√©sente
		  // Force reflow pour relancer l'anim m√™me si le bouton venait d'√™tre upgrad√©
		  void btn.offsetWidth;
		  btn.classList.add('bought-flash');
		  setTimeout(() => btn.classList.remove('bought-flash'), 280);
		}
	  }, 60); // petit d√©lai pour que le bouton existe apr√®s le render
	});

    setInterval(drawHUD, 150);
    setInterval(() => { if(lobbyStarted) socket.emit('requestZombies'); }, 500);

	// --- SHOP BTN LOGIC ---
	const shopBtn = document.getElementById('shopBtn');
	const shopModal = document.getElementById('shopModal');
	const shopClose = document.getElementById('shopClose');

	function closeShopIfOutside(evt) {
	  if (shopModal.style.display !== 'block') return;
	  const target = evt.target;
	  // Ne ferme pas si on clique sur le bouton ou dans le panneau
	  if (shopModal.contains(target) || shopBtn.contains(target)) return;
	  shopModal.style.display = 'none';
	}
	document.addEventListener('pointerdown', closeShopIfOutside, { passive: true });

	// --- RENDER SHOP UPGRADES ---
	function renderShopUpgrades() {
	  const el = document.getElementById('shopUpgrades');
	  el.innerHTML = "";
	  UPGRADES.forEach(upg => {
		const lvl = myUpgrades[upg.id] || 0;
		const value = upg.getValue(upg.baseValue, lvl);
		const nextValue = upg.getValue(upg.baseValue, lvl+1);
		let price = 10;
		if (lvl === 1) price = 25;
		else if (lvl === 2) price = 50;
		else if (lvl >= 3) price = 50 + 25 * (lvl-2);
		const disabled = myMoney < price;
		
		el.innerHTML += `
		  <div style="display:flex; align-items:center; gap:14px; margin-bottom:19px; background:#222a; border-radius:10px; padding:12px 14px 10px 7px;">
			<!-- SUPPRIMER L'IMAGE ICI -->
			<div style="flex:1;">
			  <div style="font-size:18px;"><b>${upg.label}</b></div>
			  <div style="font-size:14px; color:#fffa; margin-bottom:3px;">${upg.desc}</div>
			  <div style="font-size:15px; color:#bcffa8;">
				${upg.statLabel}¬†: <b>${upg.format(value)}</b>
				<span style="color:#8f8; font-size:14px; margin-left:7px;">${lvl<7?"‚Üí "+upg.format(nextValue):""}</span>
			  </div>
			</div>
			<div style="
			  background:#282;
			  color:#fff;
			  font-weight:bold;
			  border-radius:7px;
			  font-size:15px;
			  min-width:30px;
			  text-align:center;
			  padding:2px 0 1px 0;
			  margin-right:10px;
			  box-shadow:0 1.5px 6px #0007;
			  border:2px solid #232;
			  ">
			  <span style="font-size:15px;">${lvl}</span>
			</div>
			<button 
			  style="
				font-size:16px; 
				background:${disabled ? '#444' : '#393'}; 
				color:#fff; 
				border:none; 
				border-radius:7px; 
				padding:7px 18px; 
				box-shadow:0 2px 8px #0004; 
				cursor:${disabled ? 'not-allowed' : 'pointer'}; 
				opacity:${disabled ? '0.5' : '1'}; 
				margin-left:8px;
				transition: background 0.16s;
			  " 
			  data-upgid="${upg.id}" 
			  ${disabled?'disabled':''}>
			  +1<br>$${price}
			</button>
		  </div>
		`;
	  });

	el.querySelectorAll('button[data-upgid]').forEach(btn => {
	  const upgId = btn.getAttribute('data-upgid');
	  btn.onclick = () => {
		socket.emit('upgradeBuy', { upgId }); // demande d'achat
		// Optionnel : tu peux d√©sactiver le bouton le temps d'attendre la r√©ponse serveur, pour √©viter le spam.
	  };
	});
	}

	shopBtn.onclick = () => {
	  renderShopUpgrades();
	  shopModal.style.display = 'block';
	  // Recalage √† l‚Äôouverture (tailles DOM connues)
	  positionShopUI();
	};


	shopClose.onclick = () => {
	  shopModal.style.display = 'none';
	};

	// (optionnel, fermer si on clique dehors la fen√™tre)
	shopModal.addEventListener('mousedown', function(e) {
	  if (e.target === shopModal) shopModal.style.display = 'none';
	});

    updateUITexts();
    drawHUD();

    window.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 'p' && myPseudo === 'Myg') {
        socket.emit('killAllZombies');
      }
      if (e.key.toLowerCase() === 'o' && myPseudo === 'Myg') {
        socket.emit('giveMillion');
      }
    });
	
	// --- REAFFICHER LES JOYSTICKS + MAJ ZOOM SUR MOBILE APR√àS CHANGEMENT D'ORIENTATION ---
	if (isMobileDevice) {
	  window.addEventListener('resize', () => {
		updateRenderScale();
		setTimeout(() => { setupJoysticks(); positionShopUI(); }, 200);
	  });
	  window.addEventListener('orientationchange', () => {
		updateRenderScale();
		setTimeout(() => { setupJoysticks(); positionShopUI(); }, 200);
	  });
	}


	
  </script>
</body>
</html>