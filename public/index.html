<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Zombination.io</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden; background: #222; color: white;
      font-family: Arial, sans-serif;
      touch-action: none !important;
    }
    #gameCanvas { display: block; background: #222; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; touch-action: none !important;}
    #hudStats { position: fixed; left: 10px; bottom: 10px; background: rgba(0,0,0,0.7); border-radius: 7px; padding: 10px 20px 10px 15px; font-size: 18px; user-select: none; min-width: 210px; }
    #hudAlive { font-weight: bold; color: #fd7; }
    #deathScreen { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(30,0,0,0.8); z-index: 3; justify-content: center; align-items: center; flex-direction: column; }
    #deathScreenInner { background: #181818; border-radius: 20px; padding: 35px 45px; color: #fff; box-shadow: 0 6px 30px #000c; text-align: center; min-width: 320px; }
    #deathScreen h2 { margin: 0 0 15px 0; color: #fc2c3c; }
    #deathStats { margin-bottom: 15px; font-size: 20px; }
    #btnReplay { background: #222; color: #fff; padding: 10px 32px; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; transition: background 0.16s; }
    #btnReplay:hover { background: #393; color: #fff; }
    #lobbyScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; left:0;top:0;width:100vw;height:100vh;z-index:10; background: #181c; }
    #lobbyBox { background: #19191e; border-radius: 20px; padding: 36px 42px; box-shadow: 0 6px 30px #000c; min-width: 350px; min-height: 190px; text-align: center; }
    #lobbyBox input[type=text] { font-size: 20px; padding: 7px 12px; border-radius: 7px; border: 1px solid #444; outline: none; margin-bottom: 10px; width: 175px; }
    #lobbyJoin { padding: 7px 32px; border-radius: 8px; border:none; font-size: 20px; background:#49c749; color: #fff; cursor: pointer; margin-top: 7px; }
    #lobbyJoin[disabled] { opacity: 0.6; cursor: not-allowed; }
    #lobbyPlayers { margin: 18px 0 12px 0; color: #9fd; }
    #lobbyTimer { font-size: 17px; margin-bottom: 9px; }
    #lobbyStatus { margin: 4px 0 0 0; color: #ccc; font-size: 14px; }
    #versionInfo { position: fixed; right: 18px; bottom: 8px; color: #cfc; font-size: 15px; opacity: 0.7; user-select: none; z-index: 99; }
    #langSelectRow {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      gap: 13px;
      user-select: none;
    }
    .langFlag {
      width: 38px;
      height: 26px;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border 0.14s, transform 0.12s;
      background: #fff2;
      object-fit: cover;
      box-shadow: 0 2px 10px #0003;
    }
    .langFlag.selected {
      border: 2.5px solid #33fc69;
      transform: scale(1.07);
      box-shadow: 0 2px 16px #33fc6930;
    }
    #waveMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #f2f263;
      font-size: 48px;
      font-weight: bold;
      text-shadow: 2px 2px 6px #000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
      z-index: 20;
      user-select: none;
    }
    /* ---- MOBILE CONTROLS ---- */
    #mobileControls {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh; z-index: 99;
      pointer-events: none; /* Important : change dynamiquement avec JS */
      user-select: none;
      touch-action: none !important;
    }
    .joystickZone {
      position: absolute;
      width: 240px; height: 240px;
      background: rgba(70,70,70,0.13);
      border-radius: 50%;
      pointer-events: auto;
      opacity: 0.68;
      touch-action: none !important;
    }
    #joystickMove {
      left: 58px;
      bottom: 32vh;
    }
    #joystickShoot {
      right: 58px;
      bottom: 32vh;
    }
    .joystickStick {
      position: absolute;
      left: 50%; top: 50%;
      width: 160px; height: 160px;
      margin-left: -80px; margin-top: -80px;
      background: rgba(140,255,120,0.43);
      border-radius: 50%;
      box-shadow: 0 0 24px #7f7  inset;
      border: 4px solid #fff8;
      pointer-events: none;
      transition: background 0.12s;
      touch-action: none !important;
    }
    #joystickShoot .joystickStick {
      background: rgba(255,120,120,0.37);
      box-shadow: 0 0 24px #f77  inset;
    }
    @media (max-width: 800px) {
      .joystickZone { width: 180px; height: 180px; }
      .joystickStick { width: 100px; height: 100px; margin-left: -50px; margin-top: -50px; }
      #joystickMove { left: 15px; }
      #joystickShoot { right: 15px; }
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hudStats">
    <div id="hudAlive"></div>
    <div id="hudZombies"></div>
    <div id="hudKills"></div>
    <div id="hudRound"></div>
    <div id="hudHP"></div>
  </div>
  <div id="deathScreen">
    <div id="deathScreenInner">
      <h2 id="deathTitle"></h2>
      <div id="deathStats"></div>
      <button id="btnReplay"></button>
    </div>
  </div>
  <div id="lobbyScreen">
    <div id="lobbyBox">
      <div id="lobbyTitle" style="font-size: 28px; margin-bottom: 18px;"><b>Zombination.io</b></div>
      <div id="lobbyPlayers"></div>
      <div id="lobbyTimer"></div>
      <div id="lobbyStatus"></div>
      <input type="text" id="pseudoInput" maxlength="15" placeholder="" />
      <br>
      <button id="lobbyJoin"></button>
      <div id="langSelectRow"></div>
    </div>
  </div>
  <div id="versionInfo">Version 1.0.0 par Myg</div>
  <div id="waveMessage"></div>
  <div id="mobileControls">
    <div id="joystickMove" class="joystickZone">
      <div id="joystickStickMove" class="joystickStick"></div>
    </div>
    <div id="joystickShoot" class="joystickZone">
      <div id="joystickStickShoot" class="joystickStick"></div>
    </div>
  </div>
  <script src="/translations.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobile/i.test(navigator.userAgent);

    // Bloquer le pinch-zoom (zoom à deux doigts)
    if (isMobile) {
      document.getElementById('mobileControls').style.display = 'block';
      document.getElementById('mobileControls').style.pointerEvents = 'none';
      // Empêche le pinch-zoom/double-tap sur toute la page
      document.addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) e.preventDefault();
      }, { passive: false });
    }

    // ... (Lobby, traductions, variables, setup DOM...)

    // Joystick globales
    let joystickMoveDirection = { x: 0, y: 0 };
    let joystickActiveMove = false, joystickActiveShoot = false;
    let mobileMoveInterval = null;

    function setupMobileJoysticks() {
      if (!isMobile) return;
      // Move joystick
      const joyZoneMove = document.getElementById('joystickMove');
      const joyStickMove = document.getElementById('joystickStickMove');
      let moveTouchId = null;
      joyZoneMove.addEventListener('touchstart', function(e){
        let t = e.changedTouches[0];
        moveTouchId = t.identifier;
        joystickActiveMove = true;
        joyStickMove.style.background = 'rgba(160,255,100,0.7)';
      }, {passive:false});
      joyZoneMove.addEventListener('touchmove', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === moveTouchId) {
            let zoneRect = joyZoneMove.getBoundingClientRect();
            let centerX = zoneRect.left + zoneRect.width/2;
            let centerY = zoneRect.top + zoneRect.height/2;
            let dx = t.clientX - centerX;
            let dy = t.clientY - centerY;
            let len = Math.sqrt(dx*dx + dy*dy);
            if (len > 10) {
              // Direction normalisée (-1, 0, 1)
              joystickMoveDirection.x = dx / Math.abs(dx || 1);
              joystickMoveDirection.y = dy / Math.abs(dy || 1);
            } else {
              joystickMoveDirection.x = 0; joystickMoveDirection.y = 0;
            }
            let maxLen = zoneRect.width/2 - 24;
            if (len > maxLen) len = maxLen;
            joyStickMove.style.left = (50 + (dx/zoneRect.width)*100) + '%';
            joyStickMove.style.top  = (50 + (dy/zoneRect.height)*100) + '%';
          }
        }
      }, {passive:false});
      joyZoneMove.addEventListener('touchend', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === moveTouchId) {
            joystickActiveMove = false;
            joystickMoveDirection.x = joystickMoveDirection.y = 0;
            moveTouchId = null;
            joyStickMove.style.left = "50%";
            joyStickMove.style.top = "50%";
            joyStickMove.style.background = 'rgba(140,255,120,0.43)';
          }
        }
      }, {passive:false});

      // ... joystick tir dans PARTIE 2 ...
    }
    setupMobileJoysticks();
      // Joystick SHOOT
      const joyZoneShoot = document.getElementById('joystickShoot');
      const joyStickShoot = document.getElementById('joystickStickShoot');
      let joystickShootDirection = { x: 0, y: 0 }, shootTouchId = null;
      joyZoneShoot.addEventListener('touchstart', function(e){
        let t = e.changedTouches[0];
        shootTouchId = t.identifier;
        joystickActiveShoot = true;
        joyStickShoot.style.background = 'rgba(255,120,120,0.65)';
      }, {passive:false});
      joyZoneShoot.addEventListener('touchmove', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === shootTouchId) {
            let zoneRect = joyZoneShoot.getBoundingClientRect();
            let centerX = zoneRect.left + zoneRect.width/2;
            let centerY = zoneRect.top + zoneRect.height/2;
            let dx = t.clientX - centerX;
            let dy = t.clientY - centerY;
            let len = Math.sqrt(dx*dx + dy*dy);
            if (len > 10) {
              joystickShootDirection.x = dx / Math.abs(dx || 1);
              joystickShootDirection.y = dy / Math.abs(dy || 1);
            } else {
              joystickShootDirection.x = 0; joystickShootDirection.y = 0;
            }
            let maxLen = zoneRect.width/2 - 24;
            if (len > maxLen) len = maxLen;
            joyStickShoot.style.left = (50 + (dx/zoneRect.width)*100) + '%';
            joyStickShoot.style.top  = (50 + (dy/zoneRect.height)*100) + '%';
          }
        }
      }, {passive:false});
      joyZoneShoot.addEventListener('touchend', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === shootTouchId) {
            joystickActiveShoot = false;
            joystickShootDirection.x = joystickShootDirection.y = 0;
            shootTouchId = null;
            joyStickShoot.style.left = "50%";
            joyStickShoot.style.top = "50%";
            joyStickShoot.style.background = 'rgba(255,120,120,0.37)';
          }
        }
      }, {passive:false});
    } // fin setupMobileJoysticks

    // TIMER DE MOUVEMENT MOBILE (indépendant du FPS)
    if (isMobile) {
      if (mobileMoveInterval) clearInterval(mobileMoveInterval);
      mobileMoveInterval = setInterval(function() {
        if (!myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
        let player = playersHealth[myId];
        let move = 700 / 32; // 700px/seconde, 32Hz
        let newX = player.x + move * joystickMoveDirection.x;
        let newY = player.y + move * joystickMoveDirection.y;
        // Envoie toujours, même si pas de mouvement
        socket.emit('playerMovement', { x: newX, y: newY });
      }, 1000/32);

      // TIMER DE TIR MOBILE (pour tir continu dans la direction du joystick)
      setInterval(function() {
        if (!myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
        if (joystickActiveShoot && (joystickShootDirection.x !== 0 || joystickShootDirection.y !== 0)) {
          let player = playersHealth[myId];
          const targetX = player.x + joystickShootDirection.x * 1000;
          const targetY = player.y + joystickShootDirection.y * 1000;
          socket.emit('shoot', { targetX, targetY });
        }
      }, 200); // 1 balle tous les 200ms (~5/sec)
    }

    // --- BOUCLE PRINCIPALE ---
    let lastTime = 0;
    function gameLoop(timestamp = 0) {
      const deltaTime = Math.max(0.008, Math.min(0.05, (timestamp - lastTime) / 1000));
      lastTime = timestamp;
      if (!isMobile) updatePC(deltaTime);
      updateCamera();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      drawBullets();
      drawZombies();
      drawPlayers();
      drawHUD();
      if (!isDead) requestAnimationFrame(gameLoop);
    }

    function updatePC(deltaTime) {
      if (isDead || !myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
      let player = playersHealth[myId];
      let newX = player.x, newY = player.y;
      let move = 700 * deltaTime;
      let moved = false;
      if (keys['arrowup'] || keys['w']) { newY -= move; moved = true; }
      if (keys['arrowdown'] || keys['s']) { newY += move; moved = true; }
      if (keys['arrowleft'] || keys['a']) { newX -= move; moved = true; }
      if (keys['arrowright'] || keys['d']) { newX += move; moved = true; }
      let now = performance.now();
      if (moved && now - lastMoveSent > 1000/32) {
        socket.emit('playerMovement', { x: newX, y: newY });
        lastMoveSent = now;
      }
      if (mouseDown) {
        if (!shootBlocked) {
          shootBlocked = true;
          const mouseWorldX = cameraX + mousePos.x;
          const mouseWorldY = cameraY + mousePos.y;
          socket.emit('shoot', { targetX: mouseWorldX, targetY: mouseWorldY });
          setTimeout(() => { shootBlocked = false; }, 500);
        }
      }
    }

    // ... (Reste inchangé : sockets, lobby, draw, etc.)

    // Place ici tout le reste du code JS (drawMap, drawPlayers, drawBullets, drawZombies, drawHealthBar, etc.),
    // et tous les socket.on (comme dans la version précédente).

  </script>
</body>
</html>
