<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Zombination.io</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden; background: #222; color: white;
      font-family: Arial, sans-serif;
      touch-action: none !important;
    }
    #gameCanvas { display: block; background: #222; position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; touch-action: none !important;}
    #hudStats { position: fixed; left: 10px; bottom: 10px; background: rgba(0,0,0,0.7); border-radius: 7px; padding: 10px 20px 10px 15px; font-size: 18px; user-select: none; min-width: 210px; }
    #hudAlive { font-weight: bold; color: #fd7; }
    #deathScreen { display: none; position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(30,0,0,0.8); z-index: 3; justify-content: center; align-items: center; flex-direction: column; }
    #deathScreenInner { background: #181818; border-radius: 20px; padding: 35px 45px; color: #fff; box-shadow: 0 6px 30px #000c; text-align: center; min-width: 320px; }
    #deathScreen h2 { margin: 0 0 15px 0; color: #fc2c3c; }
    #deathStats { margin-bottom: 15px; font-size: 20px; }
    #btnReplay { background: #222; color: #fff; padding: 10px 32px; border: none; border-radius: 10px; font-size: 20px; cursor: pointer; transition: background 0.16s; }
    #btnReplay:hover { background: #393; color: #fff; }
    /* --- LOBBY --- */
    #lobbyScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; position: fixed; left:0;top:0;width:100vw;height:100vh;z-index:10; background: #181c; }
    #lobbyBox { background: #19191e; border-radius: 20px; padding: 36px 42px; box-shadow: 0 6px 30px #000c; min-width: 350px; min-height: 190px; text-align: center; }
    #lobbyBox input[type=text] { font-size: 20px; padding: 7px 12px; border-radius: 7px; border: 1px solid #444; outline: none; margin-bottom: 10px; width: 175px; }
    #lobbyJoin { padding: 7px 32px; border-radius: 8px; border:none; font-size: 20px; background:#49c749; color: #fff; cursor: pointer; margin-top: 7px; }
    #lobbyJoin[disabled] { opacity: 0.6; cursor: not-allowed; }
    #lobbyPlayers { margin: 18px 0 12px 0; color: #9fd; }
    #lobbyTimer { font-size: 17px; margin-bottom: 9px; }
    #lobbyStatus { margin: 4px 0 0 0; color: #ccc; font-size: 14px; }
    #versionInfo { position: fixed; right: 18px; bottom: 8px; color: #cfc; font-size: 15px; opacity: 0.7; user-select: none; z-index: 99; }
    /* --- LANG SELECT --- */
    #langSelectRow {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      gap: 13px;
      user-select: none;
    }
    .langFlag {
      width: 38px;
      height: 26px;
      border-radius: 6px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border 0.14s, transform 0.12s;
      background: #fff2;
      object-fit: cover;
      box-shadow: 0 2px 10px #0003;
    }
    .langFlag.selected {
      border: 2.5px solid #33fc69;
      transform: scale(1.07);
      box-shadow: 0 2px 16px #33fc6930;
    }
    /* --- WAVE MESSAGE --- */
    #waveMessage {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #f2f263;
      font-size: 48px;
      font-weight: bold;
      text-shadow: 2px 2px 6px #000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
      z-index: 20;
      user-select: none;
    }
    /* ---- MOBILE CONTROLS ---- */
    #mobileControls {
      display: none;
      position: fixed;
      left: 0; top: 0; width: 100vw; height: 100vh; z-index: 99;
      pointer-events: none; /* Important : change dynamiquement avec JS */
      user-select: none;
      touch-action: none !important;
    }
    .joystickZone {
      position: absolute;
      width: 240px; height: 240px;
      background: rgba(70,70,70,0.13);
      border-radius: 50%;
      pointer-events: auto;
      opacity: 0.68;
      touch-action: none !important;
    }
    #joystickMove {
      left: 48px;
      bottom: 28vh;
    }
    #joystickShoot {
      right: 48px;
      bottom: 28vh;
    }
    .joystickStick {
      position: absolute;
      left: 50%; top: 50%;
      width: 132px; height: 132px;
      margin-left: -66px; margin-top: -66px;
      background: rgba(140,255,120,0.43);
      border-radius: 50%;
      box-shadow: 0 0 24px #7f7  inset;
      border: 4px solid #fff8;
      pointer-events: none;
      transition: background 0.12s;
      touch-action: none !important;
    }
    #joystickShoot .joystickStick {
      background: rgba(255,120,120,0.37);
      box-shadow: 0 0 24px #f77  inset;
    }
    @media (max-width: 800px) {
      .joystickZone { width: 170px; height: 170px; }
      .joystickStick { width: 80px; height: 80px; margin-left: -40px; margin-top: -40px; }
      #joystickMove { left: 22px; }
      #joystickShoot { right: 22px; }
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hudStats">
    <div id="hudAlive"></div>
    <div id="hudZombies"></div>
    <div id="hudKills"></div>
    <div id="hudRound"></div>
    <div id="hudHP"></div>
  </div>
  <div id="deathScreen">
    <div id="deathScreenInner">
      <h2 id="deathTitle"></h2>
      <div id="deathStats"></div>
      <button id="btnReplay"></button>
    </div>
  </div>
  <div id="lobbyScreen">
    <div id="lobbyBox">
      <div id="lobbyTitle" style="font-size: 28px; margin-bottom: 18px;"><b>Zombination.io</b></div>
      <div id="lobbyPlayers"></div>
      <div id="lobbyTimer"></div>
      <div id="lobbyStatus"></div>
      <input type="text" id="pseudoInput" maxlength="15" placeholder="" />
      <br>
      <button id="lobbyJoin"></button>
      <div id="langSelectRow"></div>
    </div>
  </div>
  <div id="versionInfo">Version 1.0.0 par Myg</div>
  <div id="waveMessage"></div>
  <div id="mobileControls">
    <div id="joystickMove" class="joystickZone">
      <div id="joystickStickMove" class="joystickStick"></div>
    </div>
    <div id="joystickShoot" class="joystickZone">
      <div id="joystickStickShoot" class="joystickStick"></div>
    </div>
  </div>
  <script src="/translations.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Détection mobile
    const isMobile = /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|Mobile/i.test(navigator.userAgent);

    // Bloquer le pinch-zoom (zoom à deux doigts)
    if (isMobile) {
      document.getElementById('mobileControls').style.display = 'block';
      document.getElementById('mobileControls').style.pointerEvents = 'none';
      // Empêche le pinch-zoom/double-tap sur toute la page
      document.addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) e.preventDefault();
      }, { passive: false });
    }

    const LANGS = [
      { code: 'en', flag: 'gb.png', label: 'English' },
      { code: 'cn', flag: 'cn.png', label: '中文' },
      { code: 'ru', flag: 'ru.png', label: 'Русский' },
      { code: 'es', flag: 'es.png', label: 'Español' },
      { code: 'pt', flag: 'pt.png', label: 'Português' },
      { code: 'de', flag: 'de.png', label: 'Deutsch' },
      { code: 'jp', flag: 'jp.png', label: '日本語' },
      { code: 'fr', flag: 'fr.png', label: 'Français' },
      { code: 'pl', flag: 'pl.png', label: 'Polski' },
      { code: 'kr', flag: 'kr.png', label: '한국어' }
    ];

    function getDefaultLang() { return "en"; }
    let currentLang = getDefaultLang();

    let lobbyData = {
      started: false, count: 0, max: 5, timeLeft: 30, players: {}
    };
    let lobbyJoined = false, lobbyStarted = false;

    function initLobbyTexts() {
      updateLobbyTexts();
      pseudoInput.placeholder = TRANSLATIONS[currentLang].enterPseudo;
      lobbyJoin.textContent = TRANSLATIONS[currentLang].join;
    }
    function updateLobbyTexts() {
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      lobbyPlayers.textContent = `${tr.playersInGame} : ${lobbyData.count}/${lobbyData.max}`;
      lobbyTimer.textContent = `${tr.timeLeft} : ${lobbyData.timeLeft}s`;
      const readyCount = Object.values(lobbyData.players).filter(p=>p.ready).length;
      lobbyStatus.textContent = `${tr.waitingStart} (${readyCount} ${tr.playersReady}${readyCount>1?'s':''})`;
    }
    function updateUITexts() {
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      document.getElementById('lobbyTitle').innerHTML = `<b>${tr.zombination}</b>`;
      pseudoInput.placeholder = tr.enterPseudo;
      lobbyJoin.textContent = lobbyJoined ? tr.waiting : tr.join;
      document.getElementById('deathTitle').textContent = tr.youDied;
      btnReplay.textContent = tr.replay;
      if (!lobbyStarted) updateLobbyTexts();
    }
    const langSelectRow = document.getElementById('langSelectRow');
    function renderLangFlags() {
      langSelectRow.innerHTML = '';
      LANGS.forEach(lang => {
        const img = document.createElement('img');
        img.src = `/flags/${lang.flag}`;
        img.alt = lang.label;
        img.title = lang.label;
        img.className = 'langFlag' + (lang.code === currentLang ? ' selected' : '');
        img.onclick = () => {
          if (currentLang !== lang.code) {
            currentLang = lang.code;
            renderLangFlags();
            updateUITexts();
            drawHUD();
          }
        };
        langSelectRow.appendChild(img);
      });
    }

    // Sélection des éléments DOM
    const pseudoInput = document.getElementById('pseudoInput');
    const lobbyJoin = document.getElementById('lobbyJoin');
    const lobbyPlayers = document.getElementById('lobbyPlayers');
    const lobbyTimer = document.getElementById('lobbyTimer');
    const lobbyStatus = document.getElementById('lobbyStatus');
    const deathTitle = document.getElementById('deathTitle');
    const deathStats = document.getElementById('deathStats');
    const btnReplay = document.getElementById('btnReplay');
    renderLangFlags();
    initLobbyTexts();

    const socket = io();

    // Canvas et variables globales
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const hudAlive = document.getElementById('hudAlive');
    const hudZombies = document.getElementById('hudZombies');
    const hudKills = document.getElementById('hudKills');
    const hudRound = document.getElementById('hudRound');
    const hudHP = document.getElementById('hudHP');
    const waveMessage = document.getElementById('waveMessage');
    let currentRound = 1;
    let playersHealth = {}, zombies = {}, bullets = {};
    let myId = null, playerHealth = 100, isDead = false, myKills = 0, myPseudo = "";

    const PLAYER_SPEED_PER_SEC = 700;
    const TILE_SIZE = 40, PLAYER_RADIUS = 10, ZOMBIE_RADIUS = 10;
    let map = [];
    let MAP_ROWS = 0, MAP_COLS = 0;
    let cameraX = 0, cameraY = 0;
    const keys = {};
    let mouseDown = false;
    let mousePos = { x: 0, y: 0 };

    window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
    window.addEventListener('mousedown', e => { mouseDown = e.button === 0; });
    window.addEventListener('mouseup', e => { if (e.button === 0) mouseDown = false; });
    window.addEventListener('mousemove', e => { mousePos = { x: e.clientX, y: e.clientY }; });

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ... JOYSTICK, update, boucle, sockets dans la suite ...
    // JOYSTICK MOBILE LOGIC
    let joystickDirMove = {x:0, y:0}, joystickDirShoot = {x:0, y:0};
    let joystickActiveMove = false, joystickActiveShoot = false;

    function setupMobileJoysticks() {
      if (!isMobile) return;
      // Move joystick
      const joyZoneMove = document.getElementById('joystickMove');
      const joyStickMove = document.getElementById('joystickStickMove');
      let moveTouchId = null;
      joyZoneMove.addEventListener('touchstart', function(e){
        let t = e.changedTouches[0];
        moveTouchId = t.identifier;
        joystickActiveMove = true;
        joyStickMove.style.background = 'rgba(160,255,100,0.7)';
      }, {passive:false});
      joyZoneMove.addEventListener('touchmove', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === moveTouchId) {
            let zoneRect = joyZoneMove.getBoundingClientRect();
            let centerX = zoneRect.left + zoneRect.width/2;
            let centerY = zoneRect.top + zoneRect.height/2;
            let dx = t.clientX - centerX;
            let dy = t.clientY - centerY;
            let len = Math.sqrt(dx*dx + dy*dy);
            if (len > 10) {
              // Envoie toujours à vitesse max
              joystickDirMove.x = dx / Math.abs(dx || 1);
              joystickDirMove.y = dy / Math.abs(dy || 1);
            } else {
              joystickDirMove.x = 0; joystickDirMove.y = 0;
            }
            let maxLen = zoneRect.width/2 - 24;
            if (len > maxLen) len = maxLen;
            joyStickMove.style.left = (50 + (dx/zoneRect.width)*100) + '%';
            joyStickMove.style.top  = (50 + (dy/zoneRect.height)*100) + '%';
          }
        }
      }, {passive:false});
      joyZoneMove.addEventListener('touchend', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === moveTouchId) {
            joystickActiveMove = false;
            joystickDirMove.x = joystickDirMove.y = 0;
            moveTouchId = null;
            joyStickMove.style.left = "50%";
            joyStickMove.style.top = "50%";
            joyStickMove.style.background = 'rgba(140,255,120,0.43)';
          }
        }
      }, {passive:false});

      // Shoot joystick
      const joyZoneShoot = document.getElementById('joystickShoot');
      const joyStickShoot = document.getElementById('joystickStickShoot');
      let shootTouchId = null;
      joyZoneShoot.addEventListener('touchstart', function(e){
        let t = e.changedTouches[0];
        shootTouchId = t.identifier;
        joystickActiveShoot = true;
        joyStickShoot.style.background = 'rgba(255,120,120,0.65)';
      }, {passive:false});
      joyZoneShoot.addEventListener('touchmove', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === shootTouchId) {
            let zoneRect = joyZoneShoot.getBoundingClientRect();
            let centerX = zoneRect.left + zoneRect.width/2;
            let centerY = zoneRect.top + zoneRect.height/2;
            let dx = t.clientX - centerX;
            let dy = t.clientY - centerY;
            let len = Math.sqrt(dx*dx + dy*dy);
            if (len > 10) {
              joystickDirShoot.x = dx / Math.abs(dx || 1);
              joystickDirShoot.y = dy / Math.abs(dy || 1);
            } else {
              joystickDirShoot.x = 0; joystickDirShoot.y = 0;
            }
            let maxLen = zoneRect.width/2 - 24;
            if (len > maxLen) len = maxLen;
            joyStickShoot.style.left = (50 + (dx/zoneRect.width)*100) + '%';
            joyStickShoot.style.top  = (50 + (dy/zoneRect.height)*100) + '%';
          }
        }
      }, {passive:false});
      joyZoneShoot.addEventListener('touchend', function(e){
        for(let i=0;i<e.changedTouches.length;i++) {
          let t = e.changedTouches[i];
          if (t.identifier === shootTouchId) {
            joystickActiveShoot = false;
            joystickDirShoot.x = joystickDirShoot.y = 0;
            shootTouchId = null;
            joyStickShoot.style.left = "50%";
            joyStickShoot.style.top = "50%";
            joyStickShoot.style.background = 'rgba(255,120,120,0.37)';
          }
        }
      }, {passive:false});
    }
    setupMobileJoysticks();

    // Nouvelle logique: tick mouvement au moins 32 fois/seconde pour égalité mobile/PC
    let lastMoveSent = 0;
    function update(deltaTime) {
      if (isDead || !myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
      let player = playersHealth[myId];
      let newX = player.x, newY = player.y;
      let move = PLAYER_SPEED_PER_SEC * deltaTime;
      let moved = false;
      if (isMobile) {
        if (joystickActiveMove && (joystickDirMove.x !== 0 || joystickDirMove.y !== 0)) {
          newX += move * joystickDirMove.x;
          newY += move * joystickDirMove.y;
          moved = true;
        }
      } else {
        if (keys['arrowup'] || keys['w']) { newY -= move; moved = true; }
        if (keys['arrowdown'] || keys['s']) { newY += move; moved = true; }
        if (keys['arrowleft'] || keys['a']) { newX -= move; moved = true; }
        if (keys['arrowright'] || keys['d']) { newX += move; moved = true; }
      }
      // Envoi toujours au moins à 32Hz
      let now = performance.now();
      if (now - lastMoveSent > 1000/32) {
        socket.emit('playerMovement', { x: newX, y: newY });
        lastMoveSent = now;
      }
      // SHOOT on mobile
      if (isMobile && joystickActiveShoot && (joystickDirShoot.x !== 0 || joystickDirShoot.y !== 0)) {
        if (!shootBlocked) {
          shootBlocked = true;
          const targetX = player.x + joystickDirShoot.x * 1000;
          const targetY = player.y + joystickDirShoot.y * 1000;
          socket.emit('shoot', { targetX, targetY });
          setTimeout(() => { shootBlocked = false; }, 500);
        }
      }
      // SHOOT on PC
      if (!isMobile && mouseDown) {
        if (!shootBlocked) {
          shootBlocked = true;
          const mouseWorldX = cameraX + mousePos.x;
          const mouseWorldY = cameraY + mousePos.y;
          socket.emit('shoot', { targetX: mouseWorldX, targetY: mouseWorldY });
          setTimeout(() => { shootBlocked = false; }, 500);
        }
      }
    }

    let shootBlocked = false;

    function updateCamera() {
      if (!myId || !playersHealth[myId] || !playersHealth[myId].alive) return;
      let player = playersHealth[myId];
      cameraX = player.x - canvas.width / 2;
      cameraY = player.y - canvas.height / 2;
      if (isMobile) {
        cameraX -= canvas.width * 0.12;
        cameraY -= canvas.height * 0.08;
      }
      cameraX = Math.max(0, Math.min(cameraX, MAP_COLS * TILE_SIZE - canvas.width));
      cameraY = Math.max(0, Math.min(cameraY, MAP_ROWS * TILE_SIZE - canvas.height));
    }

    function drawMap() {
      if (!map.length) return;
      const startCol = Math.floor(cameraX / TILE_SIZE);
      const startRow = Math.floor(cameraY / TILE_SIZE);
      const visibleCols = Math.ceil(canvas.width / TILE_SIZE) + 2;
      const visibleRows = Math.ceil(canvas.height / TILE_SIZE) + 2;
      for (let row = startRow; row < startRow + visibleRows; row++) {
        if (row < 0 || row >= MAP_ROWS) continue;
        for (let col = startCol; col < startCol + visibleCols; col++) {
          if (col < 0 || col >= MAP_COLS) continue;
          if (map[row][col] === 1) {
            ctx.fillStyle = '#363636';
            ctx.fillRect(
              col * TILE_SIZE - cameraX,
              row * TILE_SIZE - cameraY,
              TILE_SIZE,
              TILE_SIZE
            );
          }
        }
      }
    }

    function drawPlayers() {
      for (const id in playersHealth) {
        const p = playersHealth[id];
        if (!p.alive) continue;
        const screenX = p.x - cameraX;
        const screenY = p.y - cameraY;
        ctx.beginPath();
        ctx.fillStyle = (id === myId) ? 'lime' : '#cfc';
        ctx.arc(screenX, screenY, PLAYER_RADIUS, 0, Math.PI * 2);
        ctx.fill();
        ctx.font = "bold 17px Arial";
        ctx.textAlign = "center";
        ctx.fillStyle = "#aad8ff";
        ctx.fillText(p.pseudo || "Joueur", screenX, screenY - PLAYER_RADIUS - 22);
        drawHealthBar(screenX, screenY - PLAYER_RADIUS - 13, p.health, 100, 32, 6);
      }
    }

    function drawZombies() {
      for (const id in zombies) {
        const z = zombies[id];
        const screenX = z.x - cameraX;
        const screenY = z.y - cameraY;
        ctx.beginPath();
        ctx.fillStyle = 'red';
        ctx.arc(screenX, screenY, ZOMBIE_RADIUS, 0, Math.PI * 2);
        ctx.fill();
        drawHealthBar(screenX, screenY - ZOMBIE_RADIUS - 10, z.hp, z.maxHp || 10);
      }
    }

    function drawBullets() {
      for (const id in bullets) {
        const b = bullets[id];
        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = (b.owner === myId) ? 'yellow' : '#ff0';
        ctx.lineWidth = 3;
        ctx.moveTo(b.x - cameraX, b.y - cameraY);
        ctx.lineTo(
          b.x - cameraX - b.dx * 8,
          b.y - cameraY - b.dy * 8
        );
        ctx.stroke();
        ctx.restore();
      }
    }

    function drawHealthBar(x, y, current, max, width = 30, height = 5) {
      const ratio = Math.max(0, Math.min(1, current / max));
      ctx.fillStyle = '#111';
      ctx.fillRect(x - width/2, y, width, height);
      ctx.fillStyle = (ratio < 0.4) ? "#e66" : "#8f8";
      ctx.fillRect(x - width/2, y, width * ratio, height);
      ctx.strokeStyle = '#fff';
      ctx.strokeRect(x - width/2, y, width, height);
    }

    function drawHUD() {
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      const aliveCount = Object.values(playersHealth).filter(p => p.alive).length;
      hudAlive.textContent = `${tr.alive} : ${aliveCount}`;
      hudZombies.textContent = `${tr.zombiesLeft}: ${Object.keys(zombies).length}`;
      hudKills.textContent = `${tr.kills}: ${myKills}`;
      hudRound.textContent = `${tr.round}: ${currentRound}`;
      hudHP.textContent = `${tr.health}: ${Math.round(playerHealth)}`;
    }

    function showDeathScreen(kills = myKills, round = currentRound) {
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      deathStats.innerHTML = `${tr.zombiesKilled}: <b>${kills}</b><br>${tr.roundReached}: <b>${round}</b>`;
      deathScreen.style.display = 'flex';
    }
    btnReplay.onclick = () => { location.reload(); };

    let lastTime = 0;
    function gameLoop(timestamp = 0) {
      const deltaTime = Math.max(0.008, Math.min(0.05, (timestamp - lastTime) / 1000));
      lastTime = timestamp;
      update(deltaTime);
      updateCamera();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap();
      drawBullets();
      drawZombies();
      drawPlayers();
      drawHUD();
      if (!isDead) requestAnimationFrame(gameLoop);
    }

    // SOCKETS, GESTION LOBBY, ETC.
    socket.on('connect', () => { myId = socket.id; });

    socket.on('lobbyUpdate', (data) => {
      lobbyData = {
        ...data,
        players: {...data.players}
      };
      const tr = TRANSLATIONS[currentLang] || TRANSLATIONS['en'];
      if (data.started) {
        lobbyScreen.style.display = 'none';
        lobbyStarted = true;
        if (isMobile) document.getElementById('mobileControls').style.pointerEvents = 'auto';
        return;
      }
      lobbyScreen.style.display = 'flex';
      lobbyStarted = false;
      if (isMobile) document.getElementById('mobileControls').style.pointerEvents = 'none';
      updateLobbyTexts();
      lobbyJoin.disabled = lobbyJoined;
      pseudoInput.disabled = lobbyJoined;
      if (lobbyJoined) lobbyJoin.textContent = tr.waiting;
      else lobbyJoin.textContent = tr.join;
    });

    lobbyJoin.onclick = () => {
      if (!pseudoInput.value.trim()) {
        pseudoInput.focus();
        pseudoInput.style.background = "#fdd";
        setTimeout(() => pseudoInput.style.background = "", 600);
        return;
      }
      socket.emit('setPseudoAndReady', pseudoInput.value.trim());
      myPseudo = pseudoInput.value.trim();
      lobbyJoined = true;
      lobbyJoin.disabled = true;
      pseudoInput.disabled = true;
      lobbyJoin.textContent = TRANSLATIONS[currentLang].waiting;
    };

    pseudoInput.onkeydown = (e) => {
      if (e.key === "Enter") lobbyJoin.click();
    };

    socket.on('gameStarted', (data) => {
      map = data.map;
      MAP_ROWS = map.length;
      MAP_COLS = map[0].length;
      playersHealth = data.players;
      currentRound = data.round;
      lobbyScreen.style.display = 'none';
      isDead = false; playerHealth = 100; myKills = 0;
      setTimeout(()=>{ gameLoop(); }, 400);
      if (isMobile) document.getElementById('mobileControls').style.pointerEvents = 'auto';
    });

    socket.on('playersHealthUpdate', (players) => {
      playersHealth = players;
      const playerId = socket.id;
      if (players[playerId]) {
        playerHealth = players[playerId].health;
      }
    });

    socket.on('zombiesUpdate', (z) => {
      zombies = z;
    });

    socket.on('bulletsUpdate', (b) => {
      bullets = b;
    });

    socket.on('killsUpdate', (kills) => {
      myKills = kills;
      drawHUD();
    });

    socket.on('currentRound', (round) => {
      currentRound = round;  // Bien mettre à jour ici la variable
      drawHUD();             // Et redraw le HUD
    });

    socket.on('healthUpdate', (health) => {
      playerHealth = health;
      drawHUD();
    });

    socket.on('playersHealthUpdate', (playersState) => {
      for (const id in playersState) {
        if (!playersHealth[id]) playersHealth[id] = {};
        playersHealth[id].health = playersState[id].health;
        playersHealth[id].alive = playersState[id].alive;
        playersHealth[id].x = playersState[id].x;
        playersHealth[id].y = playersState[id].y;
        playersHealth[id].pseudo = playersState[id].pseudo || "Joueur";
      }
    });

    socket.on('youDied', (data) => {
      isDead = true;
      playerHealth = 0;
      showDeathScreen(data.kills, data.round);
    });

    socket.on('waveMessage', (msg) => {
      waveMessage.textContent = msg;
      waveMessage.style.opacity = '1';
      setTimeout(() => {
        waveMessage.style.opacity = '0';
      }, 2500);
    });

    setInterval(drawHUD, 150);
    setInterval(() => { if(lobbyStarted) socket.emit('requestZombies'); }, 100);

    updateUITexts();
    drawHUD();

    window.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 'p' && myPseudo === 'Myg') {
        socket.emit('killAllZombies');
      }
    });
  </script>
</body>
</html>
